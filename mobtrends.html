<!DOCTYPE html>
<html>
<head>
  <!-- Meta pour la vue sur les appareils mobiles -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Chargement des bibliothèques -->
  <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1.3.0/dist/aframe-master.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

  <!-- Script pour le composant personnalisé "play-pause" -->
  <script>

    // Composant Play-Pause pour les vidéos

    AFRAME.registerComponent("play-pause", {
      init: function() {

        // Au clique sur un élément qui a play-pause
        this.el.addEventListener("click", (e)=>{

          // Récupère l'id de l'élément sur lequel on cliqué
          const id = $(this.el).attr("id");

          // On récupère sa vidéo associé dans les assets
          const video = document.getElementById('video-' + id);

          // on récupère son bouton de lecture 
          const videoControls = document.getElementById('image-'+ id);

          // Vérifier si la vidéo est en pause
          if (video.paused) {
            // Si la vidéo est en pause on lance la vidéo et on change la source du bouton de lecture pour le mettre sur le signe pause
            video.play();
            videoControls.setAttribute("src" , "#pause")
          } else {
            // Si la vidéo n'est pas en pause on met en pause la vidéo et on change la source du bouton de lecture pour le mettre sur le signe play
            video.pause();
            videoControls.setAttribute("src" , "#play")
          }
        })


      }
    })
  </script>

  <style> 

        .sound-on{ background-image: url('images/sound.png') !important; background-color:green !important;}
    
  </style>

</head>
<body>

  <!-- Scène A-Frame -->
  <a-scene cursor="rayOrigin: mouse" mindar-image="imageTargetSrc: images/mobTrend.mind; filterMinCF:0.0005; filterBeta: 0.0005" color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
 
    <!-- Ressources pré-chargées -->
    <a-assets>
      <video id="video-maVideo1"  autoplay loop src="videos/octo-video.mp4"></video>
      <video id="video-maVideo2" autoplay loop src="videos/octo-video2.mp4"></video>
      <video id="video-maVideo3"  autoplay loop src="videos/octo-video3.mp4"></video>
      <img id="play" src="images/play-button.png" >
      <img id="pause" src="images/pause.png" >
    </a-assets>

    <!-- Caméra -->
    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <!-- Entité vidéo avec cible MindAR -->
    <a-entity class="video" id="maVideo1" mindar-image-target="targetIndex: 0" raycaster="objects: #maVideo1, #image" play-pause>
      <a-video  id="maVideo1" src="#video-maVideo1" position="0 0 0" height="0.5" width="0.5" rotation="0 0 0" >
          <a-image id="image-maVideo1" src="#play" position="0 -0.35 0" height="0.15" width="0.15" rotation="1 0 0" ></a-image>
      </a-video>
    </a-entity>

    <a-entity class="video" id="maVideo2" mindar-image-target="targetIndex: 1" raycaster="objects: #maVideo2, #image" play-pause>
        <a-video id="maVideo2" src="#video-maVideo2" position="0 0 0" height="0.5" width="0.5" rotation="0 0 0" >
            <a-image id="image-maVideo2" src="#play" position="0 -0.35 0" height="0.15" width="0.15" rotation="1 0 0" ></a-image>
        </a-video>
      </a-entity>

      <a-entity class="video" id="maVideo3" mindar-image-target="targetIndex: 2" raycaster="objects: #maVideo3, #image" play-pause>
        <a-video id="maVideo3" src="#video-maVideo3" position="0 0 0" height="0.5" width="0.5" rotation="0 0 0" >
            <a-image id="image-maVideo3" src="#play" position="0 -0.35 0" height="0.15" width="0.15" rotation="1 0 0" ></a-image>
        </a-video>
      </a-entity>
    
  </a-scene>

  <div style="display:flex;flex-direction:row;position:absolute;right:20px;bottom:20px" > 

        <!-- Bouton de rechargement -->
        <div id="reload" style="display:none;width:25px;margin-right:20px;background-image: url('images/reload.png');background-size:cover;background-color:red;height:25px;"> </div>

        <div id="sound" class="sound-on" style="display:none;width:25px;background-image: url('images/no-sound.png');background-size:cover;background-color:red;height:25px;"> </div>

        
  </div>


  <script>

        let currentVideoId = null;
        let videoActuel = null;
        let videoActuelControls = null;
        const reloadButton = document.getElementById("reload");
        const soundButton = document.getElementById("sound");

        // Script pour détecter les événements de cible trouvée ou perdue

        // Sélectionner tous les éléments avec la classe .video
        const videos = document.querySelectorAll('.video');

        // Itérer sur chaque élément sélectionné
        videos.forEach(video => {

                // Ajouter un écouteur d'événements pour "targetFound", c'est à dire quand le marqueur est détecté par la caméra
                video.addEventListener("targetFound", event => {

                    // On récupère l'ID de a-video associé au marqueur détecté
                    currentVideoId = video.id;

                    // On sélectionne sa vidéo associé qui est dans a-assets
                    videoActuel = document.getElementById('video-' + currentVideoId);

                    // On sélectionne son image de contrôle de la vidéo
                    videoActuelControls = document.getElementById('image-'+ currentVideoId);

                    // On affiche les boutons reload et sound lorsqu'une vidéo est détectée
                    document.getElementById("reload").style.display = "block";
                    document.getElementById("sound").style.display = "block";

                    if (soundButton.classList.contains("sound-on")) {
                        // Si oui, mettre muted à true
                        videoActuel.muted = false;

                    } else {
                        // Sinon, mettre muted à false
                        videoActuel.muted = true;
                    }

                });

                // Ajouter un écouteur d'événements pour "targetLost"
                video.addEventListener("targetLost", event => {
                    console.log("target lost");
                    // Masquer le bouton "reload"
                    document.getElementById("reload").style.display = "none";
                    document.getElementById("sound").style.display = "none";
                    videoActuel.pause();
                    videoActuelControls.setAttribute("src" , "#play")
                });
        });

        // Ajouter un écouteur d'événements pour l'événement "click"
        reloadButton.addEventListener("click", event => {
        // Action à effectuer lors du clic sur le bouton "reload"
            console.log(currentVideoId);
            videoActuel.load();
            videoActuel.play();
            videoActuelControls.setAttribute("src" , "#pause")
        // Insérez ici le code pour recharger ou rafraîchir les éléments nécessaires
        });

        soundButton.addEventListener("click", event => {
            // Vérifier si l'élément contient la classe sound-on
            if (soundButton.classList.contains("sound-on")) {
                // Si oui, mettre muted à true
                videoActuel.muted = true;
                soundButton.classList.toggle("sound-on");

            } else {
                // Sinon, mettre muted à false
                videoActuel.muted = false;
                soundButton.classList.toggle("sound-on");
            }
        });


  </script>

</body>
</html>

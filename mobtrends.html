<!DOCTYPE html>
<html>
<head>
  <!-- Meta pour la vue sur les appareils mobiles -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Chargement des bibliothèques -->
  <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1.3.0/dist/aframe-master.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

  <!-- Script pour le composant personnalisé "play-pause" -->
  <script>

    // register component

    AFRAME.registerComponent("zoom", {
        // init callback
        init: function() {
        // react to press / release events to know if the element is selected
        this.el.addEventListener("mousedown", e => {
            this.selected = true;
            console.log("mousedown")
        })
        this.el.addEventListener("mouseup", e => {
            this.selected = false;
            console.log("mouseup")
        })
        this.el.sceneEl.addEventListener("mousewheel", evt => {
            console.log("mousewheel")
            if (!this.selected) return; // ignore when not selected
            
            const scale_factor = evt.deltaY < 0 ? 1.1 : 0.9; // scale up or down depending on the scroll direction
            
            // Appliquer la nouvelle échelle
            const newScale = this.el.object3D.scale.clone().multiplyScalar(scale_factor);
            
            // Limiter l'échelle maximale
            const maxScale = 5; // Mettez la valeur maximale que vous souhaitez
            if (newScale.x <= maxScale && newScale.y <= maxScale && newScale.z <= maxScale) {
                // Limiter l'échelle minimale
                const minScale = 0.5; // Mettez la valeur minimale que vous souhaitez
                if (newScale.x >= minScale && newScale.y >= minScale && newScale.z >= minScale) {
                    this.el.object3D.scale.copy(newScale);
                }
            }
            
            evt.preventDefault();
        });
        }
    })

    // Composant Play-Pause pour les vidéos

    AFRAME.registerComponent("play-pause", {
      init: function() {

        // Au clique sur un élément qui a play-pause
        this.el.addEventListener("click", (e)=>{

          // Récupère l'id de l'élément sur lequel on cliqué
          const id = $(this.el).attr("id");

          // On récupère sa vidéo associé dans les assets
          const video = document.getElementById('video-' + id);

          // on récupère son bouton de lecture 
          const videoControls = document.getElementById('image-'+ id);

          // Vérifier si la vidéo est en pause
          if (video.paused) {
            // Si la vidéo est en pause on lance la vidéo et on change la source du bouton de lecture pour le mettre sur le signe pause
            video.play();
            videoControls.setAttribute("src" , "#pause")
          } else {
            // Si la vidéo n'est pas en pause on met en pause la vidéo et on change la source du bouton de lecture pour le mettre sur le signe play
            video.pause();
            videoControls.setAttribute("src" , "#play")
          }
        })

      }
    })
  </script>

  <style> 

        .sound-on{ background-image: url('images/sound.png') !important;}
        #reload{width:50px;border-radius:10px;margin-right:20px;background-image: url('images/reload.png');background-size:cover;background-color:white;height:50px;}
        #sound{width:50px;margin-right:20px;border-radius:10px;background-image: url('images/no-sound.png');background-size:cover;background-color:white;height:50px;}
        #link{width:50px;border-radius:10px;background-image: url('images/picto-video.png');background-size:cover;background-color:white;height:50px;}

  </style>

</head>
<body>

  <!-- Scène A-Frame -->
  <a-scene cursor="rayOrigin: mouse" mindar-image="imageTargetSrc: images/mobTrend.mind; filterMinCF:0.0005; filterBeta: 0.0005" color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
 
    <!-- Ressources pré-chargées -->
    <a-assets>
      <video id="video-maVideo1"  autoplay loop src="videos/octo-video.mp4"></video>
      <video id="video-maVideo2" autoplay loop src="videos/octo-video2.mp4"></video>
      <video id="video-maVideo3"  autoplay loop src="videos/octo-video3.mp4"></video>
      <img id="play" src="images/play-button.png" >
      <img id="pause" src="images/pause.png" >
      <a-asset-item id="octo3D" src="modeles3D/vaisseau.gltf"></a-asset-item>
    </a-assets>

    <!-- Caméra -->
    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <!-- Entité vidéo avec cible MindAR -->
    <a-entity data-link="https://youtu.be/cPJT95xzxt4?feature=shared" class="video" id="maVideo1" mindar-image-target="targetIndex: 0" raycaster="objects: #elementVideo" play-pause>
      <a-video zoom id="elementVideo" src="#video-maVideo1" position="0 0 0" height="0.5" width="0.5" rotation="35 0 0" >
          <a-image id="image-maVideo1" src="#play" position="0 -0.35 0" height="0.15" width="0.15" rotation="0 0 0" ></a-image>
      </a-video>
    </a-entity>

    <a-entity data-link="https://youtu.be/SgyQNqwt68w?feature=shared" class="video" id="maVideo2" mindar-image-target="targetIndex: 1" raycaster="objects: #elementVideo" play-pause>
        <a-video zoom id="elementVideo" src="#video-maVideo2" position="0 0 0" height="0.5" width="0.5" rotation="35 0 0" >
            <a-image id="image-maVideo2" src="#play" position="0 -0.35 0" height="0.15" width="0.15" rotation="0 0 0" ></a-image>
        </a-video>
      </a-entity>

      <a-entity data-link="https://youtu.be/V5vKjrIqmkw?feature=shared" class="video" id="maVideo3" mindar-image-target="targetIndex: 2" raycaster="objects: #elementVideo, #model" play-pause>
        
            <a-video zoom id="elementVideo" src="#video-maVideo3" position="0 0 0" height="0.5" width="0.5" rotation="35 0 0" >
                <a-image id="image-maVideo3" src="#play" position="0 -0.35 0" height="0.15" width="0.15" rotation="0 0 0" ></a-image>
            </a-video>
        
            <a-gltf-model id="model" rotation="0 0 0 " position="0 0.5 0" scale="0.1 0.1 0.1" src="#octo3D" >
        
      </a-entity>
    
  </a-scene>

  <div id="boutons-controls" style="display:none;flex-direction:row;position:absolute;right:20px;bottom:20px" > 

        <!-- Bouton de rechargement -->
        <div id="reload" > </div>

        <div id="sound" class="sound-on"> </div>
        
        <a href="#" id="link" class="link" target="_blank"> </a>

  </div>


  <script>

        let currentVideoId = null;
        let videoActuel = null;
        let videoActuelControls = null;
        const reloadButton = document.getElementById("reload");
        const soundButton = document.getElementById("sound");

        // Script pour détecter les événements de cible trouvée ou perdue

        // Sélectionner tous les éléments avec la classe .video
        const videos = document.querySelectorAll('.video');

        // Itérer sur chaque élément sélectionné
        videos.forEach(video => {

                // Ajouter un écouteur d'événements pour "targetFound", c'est à dire quand le marqueur est détecté par la caméra
                video.addEventListener("targetFound", event => {

                    // On récupère l'ID de a-video associé au marqueur détecté
                    currentVideoId = video.id;

                    // On récupère le lien de la vidéo qui apparaît
                    var link = document.getElementById(currentVideoId).getAttribute("data-link");

                    // On change le lien du bouton de lien pour qu'il renvoie vers le lien de la vidéo actuel
                    document.getElementById("link").href = link;

                    // On sélectionne sa vidéo associé qui est dans a-assets
                    videoActuel = document.getElementById('video-' + currentVideoId);

                    // On sélectionne son image de contrôle de la vidéo
                    videoActuelControls = document.getElementById('image-'+ currentVideoId);

                    // On affiche les boutons reload et sound lorsqu'une vidéo est détectée
                    document.getElementById("boutons-controls").style.display = "flex";

                    // Si le bouton du son contient la class sound-on alors on ne mute pas la vidéo
                    if (soundButton.classList.contains("sound-on")) {
                        
                        videoActuel.muted = false;

                    // Si le bouton du son ne contient pas la class sound-on alors on mute la vidéo
                    } else {
                        
                        videoActuel.muted = true;
                    }

                });

                // Ajouter un écouteur d'événements pour "targetLost", donc quand le marqueur est perdu par la caméra
                video.addEventListener("targetLost", event => {

                    //On masque les boutons reload et sound
                    document.getElementById("boutons-controls").style.display = "none";

                    //On met la vidéo qui était visible en pause
                    videoActuel.pause();

                    //On met l'image de contrôle de cette vidéo sur play
                    videoActuelControls.setAttribute("src" , "#play")

                });
        });

        // Lorsque l'on clique sur le bouton reload
        reloadButton.addEventListener("click", event => {

            // On remet la vidéo actuel à 0
            videoActuel.load();
            // On la relance à nouveau
            videoActuel.play();
            // On met l'image de contrôle de la vidéo sur pause
            videoActuelControls.setAttribute("src" , "#pause")
        });

        // Lorsque l'on clique sur le bouton de son 
        soundButton.addEventListener("click", event => {
            
            // On regarde si le bouton contient la classe sound-on et donc si le son est activé
            if (soundButton.classList.contains("sound-on")) {
                
                // Si le son est activé on passe en muted
                videoActuel.muted = true;
                // On met à jour l'image du bouton en toogle la classe sound-on
                soundButton.classList.toggle("sound-on");

            } else {
                
                // Si le son est muted on l'active
                videoActuel.muted = false;
                soundButton.classList.toggle("sound-on");
            }
        });


  </script>

</body>
</html>
